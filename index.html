<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gas Stop Planner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family: system-ui, sans-serif; transition: all .2s ease; }
    body { background:#0d1117; color:#e6edf3; display:flex; flex-direction:column; min-height:100vh; }

    header { padding:1rem 1.5rem; border-bottom:1px solid #222; background:#0d1117; display:flex; justify-content:space-between; align-items:center; backdrop-filter: blur(12px); position:sticky; top:0; z-index:10; }
    header h1 { font-size:1.4rem; font-weight:700; }

    main { flex:1; display:grid; grid-template-columns:340px 1fr; gap:1rem; padding:1rem 1.5rem; }
    @media(max-width:850px){ main{ grid-template-columns:1fr; } }

    .panel { background:#161b22dd; border:1px solid #30363d; border-radius:1rem; padding:1rem; display:flex; flex-direction:column; backdrop-filter: blur(20px); box-shadow:0 0 25px #00000044; }
    .panel:hover { box-shadow:0 0 35px #00000066; transform:translateY(-2px); }

    .panel h2 { font-size:1.1rem; margin-bottom:0.5rem; font-weight:600; }

    form { display:flex; flex-direction:column; gap:1rem; animation:fadeUp .5s ease forwards; opacity:0; }
    @keyframes fadeUp { to { opacity:1; transform:translateY(0); } from { opacity:0; transform:translateY(10px);} }

    label { font-size:0.82rem; opacity:0.8; margin-bottom:0.25rem; display:block; }

    input { width:100%; padding:0.55rem 0.7rem; border-radius:0.5rem; border:1px solid #30363d; background:#0d1117; color:#e6edf3; font-size:0.9rem; }
    input:focus{ outline:none; border-color:#58a6ff; box-shadow:0 0 8px #58a6ff55; }

    .inline-inputs { display:flex; gap:0.75rem; }
    .inline-inputs>div { flex:1; }

    button { padding:0.65rem; border-radius:0.6rem; border:none; background:#238636; color:white; font-weight:600; cursor:pointer; transition:0.15s; box-shadow:0 3px 0 #1c6a2c; }
    button:hover { background:#2ea043; transform:translateY(-2px); box-shadow:0 6px 0 #1c6a2c; }
    button:active { transform:translateY(0); box-shadow:0 3px 0 #1c6a2c; }

    #error { color:#f87171; font-size:0.85rem; margin-top:0.3rem; min-height:1em; }

    #results{ margin-top:1rem; max-height:45vh; overflow-y:auto; padding-right:0.4rem; }
    .stop-card { background:#0f1318; padding:0.75rem; border-radius:0.6rem; border:1px solid #30363d; margin-bottom:0.6rem; transform:scale(0.98); opacity:0; animation:popIn .25s ease forwards; }
    @keyframes popIn { to { transform:scale(1); opacity:1; } }
    .stop-card:hover { background:#151b23; transform:scale(1.02); }

    #map { width:100%; height:100%; min-height:400px; border-radius:1rem; overflow:hidden; filter: invert(1) hue-rotate(180deg) brightness(0.9); box-shadow:0 0 25px #00000055; }
    #map:hover { box-shadow:0 0 40px #00000088; }

    .leaflet-popup-content-wrapper { background:#161b22; color:#e6edf3; border-radius:0.5rem; border:1px solid #30363d; box-shadow:0 0 10px #0007; }
    .leaflet-popup-tip { background:#161b22; }
  </style>
</head>
<body>
  <header>
    <h1>Gas Stop Planner</h1>
  </header>

  <main>
    <section class="panel">
      <h2>Trip Planner</h2>
      <form id="trip-form">
        <div>
          <label for="origin">Start Location</label>
          <input id="origin" type="text" placeholder="e.g. Seattle" required />
        </div>

        <div>
          <label for="destination">Destination</label>
          <input id="destination" type="text" placeholder="e.g. San Francisco" required />
        </div>

        <div class="inline-inputs">
          <div>
            <label for="range">Range (mi)</label>
            <input id="range" type="number" value="350" min="20" />
          </div>
          <div>
            <label for="reserve">Reserve (mi)</label>
            <input id="reserve" type="number" value="40" min="0" />
          </div>
        </div>

        <button type="submit" id="plan-btn">Plan gas stops</button>
        <div id="error"></div>
      </form>
      <div id="results"></div>
    </section>

    <section class="panel">
      <h2>Route Map</h2>
      <div id="map"></div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
// ===== CONFIG =====
const ORS_API_KEY = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6IjcxMWQ3ZTYwZjg4ZTQzYjZiNjM0YmVjMjkxNjU5ZjNjIiwiaCI6Im11cm11cjY0In0=";

// ===== GLOBALS =====
let map, routeLayer=null, startMarker=null, endMarker=null, stopMarkers=[];

document.addEventListener("DOMContentLoaded",()=>{ initMap(); document.getElementById("trip-form").addEventListener("submit",handlePlanTrip); });

function initMap(){ map=L.map("map").setView([39.8283, -98.5795],4); L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{ attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors', maxZoom:19 }).addTo(map); }

function setPlanning(b){ const btn=document.getElementById("plan-btn"); btn.disabled=b; btn.textContent=b?"Planning...":"Plan gas stops"; }
function showError(msg){document.getElementById("error").textContent=msg||"";}
function clearError(){showError("");}
function clearResults(){document.getElementById("results").innerHTML="";}
function clearMapLayers(){ routeLayer&&map.removeLayer(routeLayer); routeLayer=null; startMarker&&map.removeLayer(startMarker); startMarker=null; endMarker&&map.removeLayer(endMarker); endMarker=null; stopMarkers.forEach(m=>map.removeLayer(m)); stopMarkers=[]; }

async function handlePlanTrip(e){ e.preventDefault(); clearError(); clearResults(); clearMapLayers(); const originText=document.getElementById("origin").value.trim(); const destinationText=document.getElementById("destination").value.trim(); const rangeMiles=Number(document.getElementById("range").value); const reserveMiles=Number(document.getElementById("reserve").value||0); if(!originText||!destinationText||!rangeMiles||rangeMiles<=0){showError("Please fill in origin, destination, and a valid range."); return;} if(reserveMiles>=rangeMiles){showError("Reserve buffer must be less than the range per tank."); return;} const usableRange=rangeMiles-reserveMiles; if(usableRange<30){showError("Usable range is too small. Increase range or decrease reserve."); return;} setPlanning(true); try{ const [origin,destination]=await Promise.all([geocodePlace(originText),geocodePlace(destinationText)]); const route=await getRoute(origin,destination); routeLayer=L.geoJSON(route.geojson,{style:{weight:4}}).addTo(map); map.fitBounds(routeLayer.getBounds(),{padding:[40,40]}); startMarker=L.marker([origin.lat,origin.lon],{title:"Start"}).addTo(map).bindPopup(`<strong>Start</strong><br>${origin.label||originText}`); endMarker=L.marker([destination.lat,destination.lon],{title:"Destination"}).addTo(map).bindPopup(`<strong>Destination</strong><br>${destination.label||destinationText}`); const totalDistanceMiles=route.distMeters/1609.344; const stopPoints=computeStopPoints(route.coords,usableRange); if(stopPoints.length===0){ renderResultsNoStops(totalDistanceMiles,rangeMiles); return;} const gasStops=await findGasStationsForStops(stopPoints); addStopMarkers(gasStops); renderResultsWithStops(totalDistanceMiles,rangeMiles,gasStops); }catch(err){ console.error(err); showError(err.message||"Failed to plan trip. Try again."); } finally{ setPlanning(false); } }

async function geocodePlace(text){ const url=`https://api.openrouteservice.org/geocode/search?api_key=${encodeURIComponent(ORS_API_KEY)}&text=${encodeURIComponent(text)}&size=1`; const res=await fetch(url); if(!res.ok)throw new Error("Geocoding failed for: "+text); const data=await res.json(); if(!data.features||!data.features.length)throw new Error("Location not found: "+text); const feature=data.features[0]; const [lon,lat]=feature.geometry.coordinates; const label=feature.properties.label; return{lat,lon,label}; }

async function getRoute(origin,destination){ const url="https://api.openrouteservice.org/v2/directions/driving-car/geojson"; const body={coordinates:[[origin.lon,origin.lat],[destination.lon,destination.lat]]}; const res=await fetch(url,{method:"POST",headers:{Authorization:ORS_API_KEY,"Content-Type":"application/json"},body:JSON.stringify(body)}); if(!res.ok)throw new Error("Routing failed. Check locations and try again."); const data=await res.json(); if(!data.features||!data.features.length)throw new Error("No route found."); const feature=data.features[0]; const coords=feature.geometry.coordinates.map(([lon,lat])=>({lon,lat})); const distMeters=feature.properties.summary.distance; return{coords,distMeters,geojson:feature};}

function distanceInMiles(lat1,lon1,lat2,lon2){ const R=3958.8; const toRad=d=>d*Math.PI/180; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; const c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); return R*c;}

function computeStopPoints(coords,usableRangeMiles){ const stops=[]; if(coords.length<2)return stops; let distanceSinceLastStop=0, cumulativeDistance=0; for(let i=1;i<coords.length;i++){ const prev=coords[i-1], curr=coords[i]; const segDist=distanceInMiles(prev.lat,prev.lon,curr.lat,curr.lon); distanceSinceLastStop+=segDist; cumulativeDistance+=segDist; if(distanceSinceLastStop>=usableRangeMiles){ stops.push({lat:curr.lat,lon:curr.lon,distanceFromStartMiles:cumulativeDistance}); distanceSinceLastStop=0; } } return stops; }

async function findGasStationsForStops(stops){ const radiusMeters=8000; const promises=stops.map(async(stop,idx)=>{ const gas=await findNearestGasStation(stop.lat,stop.lon,radiusMeters); if(!gas)return{index:idx+1,name:"Gas station not found nearby",address:"Try stopping a bit earlier or later along the route.",lat:stop.lat,lon:stop.lon,distanceFromStartMiles:stop.distanceFromStartMiles,distanceOffsetMiles:null}; return{index:idx+1,name:gas.name,address:gas.address,lat:gas.lat,lon:gas.lon,distanceFromStartMiles:stop.distanceFromStartMiles,distanceOffsetMiles:gas.distanceMiles}; }); return Promise.all(promises);}

async function findNearestGasStation(lat,lon,radiusMeters){ const query=`[out:json][timeout:25];(node["amenity"="fuel"](around:${radiusMeters},${lat},${lon}););out body;`; const url="https://overpass-api.de/api/interpreter?data="+encodeURIComponent(query); const res=await fetch(url); if(!res.ok){console.warn("Overpass request failed with status:",res.status); return null;} const data=await res.json(); if(!data.elements||!data.elements.length)return null; let best=data.elements[0]; let bestDist=distanceInMiles(lat,lon,best.lat,best.lon); for(const el of data.elements){ const d=distanceInMiles(lat,lon,el.lat,el.lon); if(d<bestDist){ best=el; bestDist=d; } } const name=(best.tags&&(best.tags.name||best.tags.brand))||"Gas station"; const addressParts=[]; if(best.tags){ if(best.tags["addr:housenumber"]||best.tags["addr:street"]) addressParts.push(`${best.tags["addr:housenumber"]||""} ${best.tags["addr:street"]||""}`.trim()); if(best.tags["addr:city"]) addressParts.push(best.tags["addr:city"]); if(best.tags["addr:state"]) addressParts.push(best.tags["addr:state"]); } const address=addressParts.join(", ")||"Address not available"; return{name,address,lat:best.lat,lon:best.lon,distanceMiles:bestDist};}

function addStopMarkers(stops){ stopMarkers.forEach(m=>map.removeLayer(m)); stopMarkers=[]; stops.forEach(stop=>{ const marker=L.marker([stop.lat,stop.lon],{title:`Stop #${stop.index}`}).addTo(map); const distFromStart=stop.distanceFromStartMiles.toFixed(1); const offset=stop.distanceOffsetMiles!=null?` (~${stop.distanceOffsetMiles.toFixed(1)} mi from ideal stop)":""; const popupHtml=`<strong>Stop #${stop.index}</strong><br/>${stop.name}<br/><small>${stop.address}</small><br/><small>Distance from start: ~${distFromStart} miles${offset}</small>`; marker.bindPopup(popupHtml); stopMarkers.push(marker);});}

function renderResultsNoStops(totalDistanceMiles,rangeMiles){ const total=totalDistanceMiles.toFixed(1); document.getElementById("results").innerHTML=`<div class="result-summary">Total trip distance: <strong>${total} miles</strong><br/>With a range of ~${rangeMiles.toFixed(0)} miles, you <strong>don't need any fuel stops</strong> on this route.</div>`;}

function renderResultsWithStops(totalDistanceMiles,rangeMiles,stops){ const total=totalDistanceMiles.toFixed(1); const stopCount=stops.length; let html=`<div class="result-summary">Total trip distance: <strong>${total} miles</strong><br/>Estimated fuel stops needed: <strong>${stopCount}</strong> (range â‰ˆ ${rangeMiles.toFixed(0)} mi)</div>`; stops.forEach(stop=>{ const dist=stop.distanceFromStartMiles.toFixed(1); const offset=stop.distanceOffsetMiles!=null?` (~${stop.distanceOffsetMiles.toFixed(1)} mi from ideal point)":""; html+=`<div class="stop-card"><div class="stop-title">Stop #${stop.index}: ${stop.name}</div><div class="stop-meta">${stop.address}</div><div class="stop-distance">Distance from start: ~${dist} miles${offset}</div></div>`;}); document.getElementById("results").innerHTML=html;}
  </script>
</body>
</html>
