<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gas Stop Planner (Dark Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body { display: flex; flex-direction: column; min-height:100vh; background:#020617; color:#e5e7eb; }
    header { padding:1rem 1.5rem; border-bottom:1px solid #1f2937; background:#020617; }
    header h1 { font-size:1.4rem; font-weight:700; }
    main { flex:1; display:grid; grid-template-columns:minmax(0,420px) minmax(0,1fr); gap:1rem; padding:1rem 1.5rem; }
    @media(max-width:900px){ main { grid-template-columns:1fr; } }
    .panel { background:#111827; border-radius:0.75rem; padding:1rem; border:1px solid #1f2937; display:flex; flex-direction:column; min-height:0; transition: all 0.3s ease; }
    .panel:hover { box-shadow:0 0 20px #2563eb33; transform: translateY(-2px); }
    .panel h2 { font-size:1rem; margin-bottom:0.75rem; font-weight:600; display:flex; align-items:center; gap:0.4rem; }
    .badge { display:inline-flex; align-items:center; border-radius:999px; border:1px solid #374151; padding:0.1rem 0.55rem; font-size:0.75rem; color:#9ca3af; }
    form { display:flex; flex-direction:column; gap:0.75rem; }
    label { font-size:0.85rem; color:#9ca3af; margin-bottom:0.1rem; display:block; }
    input { width:100%; padding:0.45rem 0.6rem; border-radius:0.5rem; border:1px solid #374151; background:#020617; color:#e5e7eb; font-size:0.9rem; transition: all 0.2s ease; }
    input:focus { outline:none; border-color:#60a5fa; box-shadow:0 0 5px #60a5fa55; }
    .inline-inputs { display:flex; gap:0.5rem; }
    .inline-inputs > div { flex:1; }
    button { margin-top:0.5rem; padding:0.6rem 0.75rem; border-radius:999px; border:none; background:#2563eb; color:white; font-size:0.9rem; font-weight:500; cursor:pointer; transition: all 0.2s ease; }
    button:hover { background:#1d4ed8; transform: scale(1.03); }
    button:disabled { opacity:0.6; cursor:default; transform:none; }
    .hint { font-size:0.8rem; color:#6b7280; margin-top:-0.3rem; }
    #error { color:#f87171; font-size:0.8rem; margin-top:0.4rem; min-height:1em; transition: all 0.2s ease; }
    #results { margin-top:1rem; max-height:50vh; overflow-y:auto; padding-right:0.25rem; }
    .result-summary { font-size:0.85rem; margin-bottom:0.5rem; color:#9ca3af; }
    .stop-card { border-radius:0.6rem; border:1px solid #1f2937; padding:0.6rem 0.7rem; margin-bottom:0.5rem; background:#111827; transition: all 0.2s ease; }
    .stop-card:hover { background:#1f2937; box-shadow:0 0 10px #2563eb33; transform: translateY(-1px); }
    .stop-title { font-size:0.9rem; font-weight:600; margin-bottom:0.1rem; }
    .stop-meta { font-size:0.8rem; color:#9ca3af; }
    .stop-distance { font-size:0.8rem; margin-top:0.2rem; }
    #map { width:100%; height:100%; min-height:400px; border-radius:0.75rem; border:1px solid #1f2937; overflow:hidden; filter: brightness(0.9) contrast(1.1); }
    .leaflet-popup-content-wrapper { background:#111827; color:#e5e7eb; border-radius:0.5rem; border:1px solid #1f2937; }
    .leaflet-popup-tip { background:#111827; }
  </style>
</head>
<body>
  <header>
    <h1>Gas Stop Planner</h1>
  </header>

  <main>
    <section class="panel">
      <h2>Trip Details <span class="badge">OSM · ORS · Overpass</span></h2>
      <form id="trip-form">
        <div>
          <label for="origin">Start location</label>
          <input id="origin" type="text" placeholder="e.g. Seattle, WA" required />
        </div>
        <div>
          <label for="destination">Destination</label>
          <input id="destination" type="text" placeholder="e.g. San Francisco, CA" required />
        </div>
        <div class="inline-inputs">
          <div>
            <label for="range">Range per tank (miles)</label>
            <input id="range" type="number" min="10" value="350" required />
            <p class="hint">Approx. distance you can drive on a full tank.</p>
          </div>
          <div>
            <label for="reserve">Reserve buffer (miles)</label>
            <input id="reserve" type="number" min="0" value="40" />
            <p class="hint">Plan stops before this buffer.</p>
          </div>
        </div>
        <button type="submit" id="plan-btn">Plan gas stops</button>
        <div id="error"></div>
      </form>
      <div id="results"></div>
    </section>

    <section class="panel">
      <h2>Route & Stops</h2>
      <div id="map"></div>
    </section>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const ORS_API_KEY = "YOUR_ORS_KEY_HERE";
    let map, routeLayer=null, startMarker=null, endMarker=null, stopMarkers=[];

    document.addEventListener("DOMContentLoaded", ()=>{
      initMap();
      document.getElementById("trip-form").addEventListener("submit", handlePlanTrip);
    });

    function initMap(){
      map=L.map("map").setView([39.8283, -98.5795], 4);
      L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png", {
        attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a>',
        subdomains:'abcd', maxZoom:19
      }).addTo(map);
    }

    function setPlanning(isPlanning){
      const btn=document.getElementById("plan-btn");
      if(!btn) return;
      btn.disabled=isPlanning;
      btn.textContent=isPlanning ? "Planning..." : "Plan gas stops";
    }

    function showError(msg){ const el=document.getElementById("error"); if(el) el.textContent=msg||""; }
    function clearError(){ showError(""); }
    function clearResults(){ document.getElementById("results").innerHTML=""; }
    function clearMapLayers(){
      if(routeLayer) map.removeLayer(routeLayer), routeLayer=null;
      if(startMarker) map.removeLayer(startMarker), startMarker=null;
      if(endMarker) map.removeLayer(endMarker), endMarker=null;
      stopMarkers.forEach(m=>map.removeLayer(m)); stopMarkers=[];
    }

    async function handlePlanTrip(e){
      e.preventDefault(); clearError(); clearResults(); clearMapLayers();
      const originText=document.getElementById("origin").value.trim();
      const destinationText=document.getElementById("destination").value.trim();
      const rangeMiles=Number(document.getElementById("range").value);
      const reserveMiles=Number(document.getElementById("reserve").value||0);
      if(!originText||!destinationText||!rangeMiles||rangeMiles<=0){showError("Please fill in origin, destination, and a valid range."); return;}
      if(reserveMiles>=rangeMiles){showError("Reserve buffer must be less than range."); return;}
      const usableRange=rangeMiles-reserveMiles;
      if(usableRange<30){showError("Usable range too small."); return;}
      setPlanning(true);
      try{
        const [origin,destination]=await Promise.all([geocodePlace(originText), geocodePlace(destinationText)]);
        const route=await getRoute(origin,destination);
        routeLayer=L.geoJSON(route.geojson,{style:{weight:4,color:"#60a5fa"}}).addTo(map);
        map.fitBounds(routeLayer.getBounds(),{padding:[40,40]});
        startMarker=L.marker([origin.lat,origin.lon],{title:"Start"}).addTo(map).bindPopup(`<strong>Start</strong><br>${origin.label||originText}`);
        endMarker=L.marker([destination.lat,destination.lon],{title:"Destination"}).addTo(map).bindPopup(`<strong>Destination</strong><br>${destination.label||destinationText}`);
        const totalDistanceMiles=route.distMeters/1609.344;
        const stopPoints=computeStopPoints(route.coords,usableRange);
        if(stopPoints.length===0){renderResultsNoStops(totalDistanceMiles,rangeMiles); return;}
        const gasStops=await findGasStationsForStops(stopPoints);
        addStopMarkers(gasStops);
        renderResultsWithStops(totalDistanceMiles,rangeMiles,gasStops);
      }catch(err){ console.error(err); showError(err.message||"Failed to plan trip."); }
      finally{ setPlanning(false); }
    }

    async function geocodePlace(text){
      const res=await fetch(`https://api.openrouteservice.org/geocode/search?api_key=${ORS_API_KEY}&text=${encodeURIComponent(text)}&size=1`);
      if(!res.ok) throw new Error("Geocoding failed: "+text);
      const data=await res.json();
      if(!data.features||!data.features.length) throw new Error("Location not found: "+text);
      const feature=data.features[0]; const [lon,lat]=feature.geometry.coordinates; return {lat,lon,label:feature.properties.label};
    }

    async function getRoute(origin,destination){
      const res=await fetch("https://api.openrouteservice.org/v2/directions/driving-car/geojson", {
        method:"POST",
        headers:{Authorization:ORS_API_KEY,"Content-Type":"application/json"},
        body:JSON.stringify({coordinates:[[origin.lon,origin.lat],[destination.lon,destination.lat]]})
      });
      if(!res.ok) throw new Error("Routing failed.");
      const data=await res.json();
      if(!data.features||!data.features.length) throw new Error("No route found.");
      const feature=data.features[0];
      const coords=feature.geometry.coordinates.map(([lon,lat])=>({lon,lat}));
      const distMeters=feature.properties.summary.distance;
      return {coords,distMeters,geojson:feature};
    }

    function distanceInMiles(lat1,lon1,lat2,lon2){ const R=3958.8; const toRad=d=>d*Math.PI/180; const dLat=toRad(lat2-lat1); const dLon=toRad(lon2-lon1); const a=Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }

    function computeStopPoints(coords,usableRangeMiles){
      const stops=[]; if(coords.length<2) return stops;
      let distSinceLast=0, cumulative=0;
      for(let i=1;i<coords.length;i++){
        const prev=coords[i-1], curr=coords[i];
        const segDist=distanceInMiles(prev.lat,prev.lon,curr.lat,curr.lon);
        distSinceLast+=segDist; cumulative+=segDist;
        if(distSinceLast>=usableRangeMiles){stops.push({lat:curr.lat,lon:curr.lon,distanceFromStartMiles:cumulative}); distSinceLast=0;}
      }
      return stops;
    }

    async function findGasStationsForStops(stops){
      const radius=8000;
      const promises=stops.map(async(stop,idx)=>{
        const gas=await findNearestGasStation(stop.lat,stop.lon,radius);
        if(!gas) return {index:idx+1,name:"Gas station not found nearby",address:"Try stopping earlier/later",lat:stop.lat,lon:stop.lon,distanceFromStartMiles:stop.distanceFromStartMiles,distanceOffsetMiles:null};
        return {index:idx+1,name:gas.name,address:gas.address,lat:gas.lat,lon:gas.lon,distanceFromStartMiles:stop.distanceFromStartMiles,distanceOffsetMiles:gas.distanceMiles};
      });
      return Promise.all(promises);
    }

    async function findNearestGasStation(lat,lon,radius){
      const query=`[out:json][timeout:25];(node["amenity"="fuel"](around:${radius},${lat},${lon}););out body;`;
      const url="https://overpass-api.de/api/interpreter?data="+encodeURIComponent(query);
      const res=await fetch(url);
      if(!res.ok) return null;
      const data=await res.json();
      if(!data.elements||!data.elements.length) return null;
      let best=data.elements[0], bestDist=distanceInMiles(lat,lon,best.lat,best.lon);
      for(const el of data.elements){ const d=distanceInMiles(lat,lon,el.lat,el.lon); if(d<bestDist){best=el; bestDist=d;} }
      const name=(best.tags&&(best.tags.name||best.tags.brand))||"Gas station";
      const addressParts=[]; if(best.tags){ if(best.tags["addr:housenumber"]||best.tags["addr:street"]) addressParts.push(`${best.tags["addr:housenumber"]||""} ${best.tags["addr:street"]||""}`.trim()); if(best.tags["addr:city"]) addressParts.push(best.tags["addr:city"]); if(best.tags["addr:state"]) addressParts.push(best.tags["addr:state"]); }
      const address=addressParts.join(", ")||"Address not available";
      return {name,address,lat:best.lat,lon:best.lon,distanceMiles:bestDist};
    }

    function addStopMarkers(stops){
      stopMarkers.forEach(m=>map.removeLayer(m)); stopMarkers=[];
      stops.forEach(stop=>{
        const marker=L.marker([stop.lat,stop.lon],{title:`Stop #${stop.index}`}).addTo(map);
        const dist=stop.distanceFromStartMiles.toFixed(1);
        const offset=stop.distanceOffsetMiles!=null?` (~${stop.distanceOffsetMiles.toFixed(1)} mi from ideal stop)`:"";
        marker.bindPopup(`<strong>Stop #${stop.index}</strong><br/>${stop.name}<br/><small>${stop.address}</small><br/><small>Distance from start: ~${dist} miles${offset}</small>`);
        stopMarkers.push(marker);
      });
    }

    function renderResultsNoStops(total,range){
      const results=document.getElementById("results");
      results.innerHTML=`<div class="result-summary">Total trip distance: <strong>${total.toFixed(1)} miles</strong><br/>With range ~${range.toFixed(0)} miles, <strong>no fuel stops needed</strong>.</div>`;
    }

    function renderResultsWithStops(total,range,stops){
      const results=document.getElementById("results");
      let html=`<div class="result-summary">Total trip distance: <strong>${total.toFixed(1)} miles</strong><br/>Estimated fuel stops: <strong>${stops.length}</strong> (range ≈ ${range.toFixed(0)} mi)</div>`;
      stops.forEach(stop=>{
        const dist=stop.distanceFromStartMiles.toFixed(1);
        const offset=stop.distanceOffsetMiles!=null?` (~${stop.distanceOffsetMiles.toFixed(1)} mi from ideal point)`:"";
        html+=`<div class="stop-card"><div class="stop-title">Stop #${stop.index}: ${stop.name}</div><div class="stop-meta">${stop.address}</div><div class="stop-distance">Distance from start: ~${dist} miles${offset}</div></div>`;
      });
      results.innerHTML=html;
    }
  </script>
</body>
</html>
